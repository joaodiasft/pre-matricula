generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  ADMIN
}

enum EnrollmentStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  WAITING_PAYMENT
  CONFIRMED
  WAITLISTED
  REJECTED
}

enum PaymentStatus {
  PENDING
  CONFIRMED
}

enum PaymentMethod {
  PIX
  CARD
  BOLETO
  PRESENTIAL
}

enum Objective {
  ENEM
  UFG_VESTIBULAR
  REFORCO
  CONCURSOS
}

enum Level {
  INICIANTE
  INTERMEDIARIO
  AVANCADO
}

enum CourseSelectionStatus {
  RESERVED
  WAITLIST
}

enum CourseModality {
  REDACAO
  EXATAS
  MATEMATICA
  GRAMATICA
}

model User {
  id             String          @id @default(cuid())
  name           String
  email          String          @unique
  password       String
  role           Role            @default(STUDENT)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  profile        StudentProfile?
  preEnrollments PreEnrollment[]
}

model StudentProfile {
  id         String    @id @default(cuid())
  userId     String    @unique
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  age        Int?
  school     String?
  grade      String?
  objective  Objective?
  level      Level?
  hasEnem    Boolean?
  enemScore  Int?
  updatedAt  DateTime  @updatedAt
  createdAt  DateTime  @default(now())
}

model Course {
  id            String           @id
  title         String
  modality      CourseModality
  description   String
  materials     String
  audience      String
  bonusLimit    Int?
  bonusAwarded  Int              @default(0)
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  sessions      CourseSession[]
  plans         PaymentPlan[]
  selections    PreEnrollmentCourseSelection[]
}

model CourseSession {
  id          String                         @id @default(cuid())
  courseId    String
  course      Course                         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  code        String                         @unique
  weekday     String
  startTime   String
  endTime     String
  level       String
  capacity    Int
  createdAt   DateTime                       @default(now())
  updatedAt   DateTime                       @updatedAt
  selections  PreEnrollmentCourseSelection[]
}

model PaymentPlan {
  id          String       @id @default(cuid())
  courseId    String
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  label       String
  months      Int
  price       Decimal      @db.Decimal(10, 2)
  discountPct Decimal?     @db.Decimal(5, 2)
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  selections  PreEnrollmentCourseSelection[]
}

model PreEnrollment {
  id                           String              @id @default(cuid())
  userId                       String
  user                         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  status                       EnrollmentStatus    @default(DRAFT)
  paymentStatus                PaymentStatus       @default(PENDING)
  paymentMethod                PaymentMethod?
  totalAmount                  Decimal             @db.Decimal(10, 2) @default(0)
  registrationFee              Decimal             @db.Decimal(10, 2) @default(0)
  registrationFeeDiscount      Boolean             @default(false)
  objective                    Objective?
  level                        Level?
  age                          Int?
  school                       String?
  grade                        String?
  studyGoal                    String?
  hasEnem                      Boolean?
  enemScore                    Int?
  confirmationDate             DateTime?
  confirmationDay              DateTime?
  token                        String?             @unique
  tokenSequence                Int?
  promoBonusGranted            Boolean             @default(false)
  hasWaitlist                  Boolean             @default(false)
  notes                        String?
  createdAt                    DateTime            @default(now())
  updatedAt                    DateTime            @updatedAt
  selections                   PreEnrollmentCourseSelection[]
}

model PreEnrollmentCourseSelection {
  id               String                @id @default(cuid())
  preEnrollmentId  String
  preEnrollment    PreEnrollment         @relation(fields: [preEnrollmentId], references: [id], onDelete: Cascade)
  courseId         String
  course           Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  sessionId        String
  session          CourseSession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  planId           String?
  plan             PaymentPlan?          @relation(fields: [planId], references: [id])
  status           CourseSelectionStatus @default(RESERVED)
  waitlistPosition Int?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
}

model TokenCounter {
  id         Int      @id
  lastNumber Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
